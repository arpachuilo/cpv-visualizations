<!DOCTYPE html>
<head>
  <meta charset='utf-8'>
  <script src='https://d3js.org/d3.v4.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/moment-duration-format/1.3.0/moment-duration-format.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.js'></script>

  <script src='./data/video-links.js'></script>

  <script src='./scripts/util.js'></script>
  <script src='./scripts/Tooltip.js'></script>
  <script src='./scripts/HeatPointChart.js'></script>
  <script src='./scripts/drawBbox.js'></script>
  <script src='./scripts/VideoHeatmap.js'></script>
  <script src='./scripts/StackedBarChart.js'></script>
  <script src='./scripts/CircularAOI.js'></script>
  <script src='./scripts/CircularDataCoverage.js'></script>
  <script src='./scripts/CircularActionSequences.js'></script>

  <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css'>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css'>
  <link rel='stylesheet' href='style.css'>

</head>
<body onresize='resize()'>

  <div class='row'>
    <div class='row'>
      <span>Dataset: </span>
      <select id='dataset' onchange='onDatasetChange()'>
        <option value='CPV-A'>CPV-A</option>
        <option value='CPV-B'>CPV-B</option>
        <option value='CPV-C'>CPV-C</option>
        <option value='CPV-D'>CPV-D</option>
        <option value='CPV-E'>CPV-E</option>
        <option value='CPV-F'>CPV-F</option>
        <option value='CPV-G'>CPV-G</option>
        <option value='CPV-H'>CPV-H</option>
        <option value='CPV-I'>CPV-I</option>
        <option value='CPV-J'>CPV-J</option>
      </select>
    </div>

    <div class='row'>
      <div class='twelve columns' id='timeControl'></div>
    </div>

    <div class='row'>
      <div class='row'>
        <div class='four columns'>
          <svg id='aoi' height='480'></svg>
          <h5 class='centered'>Area of Interest</h5>
        </div>
        <div class='four columns'>
          <svg id='datacoverage' height='480'></svg>
          <h5 class='centered'>User Data Filters</h5>
        </div>
        <div class='four columns'>
          <svg id='as' height='480'></svg>
          <h5 class='centered'>User Actions</h5>
        </div>
      </div>
    </div>
  </div>

  <div class='row'>
    <div class='key' style='background-color: orange'></div><span>Eye</span>
    <div class='key' style='background-color: green'></div><span>Mouse</span>

    <div id='video-container' class='row' style='position: relative; margin: 0 auto;'>
      <!-- <video id='user-video'>
        <source id='user-video-source' type='video/mp4'></source>
      </video> -->
      <img id='app-img' src='app.png' />
      <svg id='bbox-overlay'></svg>
      <!-- <canvas id='video-overlay'></canvas> -->
    </div>
  </div>

  <script>

  var classKeys = ['overviewHist', 'detailHist', 'graph', 'table', 'offices']

  var bounds = false

  // var videoHeatmap = VideoHeatmap(document.getElementById('video-overlay'), document.getElementById('user-video'))
  var stackedChart = StackedBarChart(d3.select('#timeControl'))
    .keys(classKeys)
    .onBrushDrag(function (e, extent) {
      bounds = extent
      drawCharts()
    })
    .onBrushClick(function () {
      bounds = false
      drawCharts()
    })

  var eyeData = []
  var mouseData = []

  function resize() {
    _.delay(function () {
      stackedChart
        .resizeFunc()
        .update()
      drawCharts()
    }, 500)
  }

  document.addEventListener('data-loaded', function () {
    // var video = document.getElementById('user-video')
    // video.pause()
    //
    // var videoSource = document.getElementById('user-video-source')
    // videoSource.setAttribute('src', videoLinks[document.getElementById('dataset').value])
    // videoHeatmap
    //   .setEyeData(eyeData)
    //   .setMouseData(mouseData)
    //
    //
    // video.play()
    bounds = false
    stackedChart
      .data(timeBinData(mouseData, 90))
      .update()
    drawCharts()
  })

  function drawCharts () {
    drawCircularAOI(convertDataForAOI(mouseData, bounds), classKeys)
    drawDataCoverage(convertDataForCoverage(mouseData, bounds))
    drawCircularActionSequence(convertDataForActionSequence(mouseData, bounds), mouseData, bounds)
  }

  function onDatasetChange () {
    loadData(document.getElementById('dataset').value)
  }

  function loadData (value) {
    d3.text('data/eye/' + value + '.csv', function(eye) {
      eyeData = d3.csvParse('status,x,y,time,aoi\n' + eye)
      d3.json('data/mouse/' + value + '.json', function (mouse) {
        mouseData = mouse

        document.dispatchEvent(new Event('data-loaded'))
      })
    })
  }

  loadData('CPV-A')
  drawBbox(bboxArray)
  </script>
</body>
