<!DOCTYPE html>
<head>
  <meta charset='utf-8'>
  <script src='https://d3js.org/d3.v4.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.js'></script>

  <script src='./scripts/util.js'></script>
  <script src='./scripts/Tooltip.js'></script>
  <script src='./scripts/HeatPointChart.js'></script>
  <script src='./scripts/StackedBarChart.js'></script>
  <script src='./scripts/CircularAOI.js'></script>
  <script src='./scripts/CircularDataCoverage.js'></script>
  <script src='./scripts/CircularActionSequences.js'></script>

  <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css'>
  <link rel='stylesheet' href='style.css'>

  <!-- <link rel='import' href='heatmap.html'> -->

</head>
<body>
  <span>Dataset: </span>
  <select id='dataset' onchange='onDatasetChange()'>
    <option value='CPV-A'>CPV-A</option>
    <option value='CPV-B'>CPV-B</option>
    <option value='CPV-C'>CPV-C</option>
    <option value='CPV-D'>CPV-D</option>
    <option value='CPV-E'>CPV-E</option>
    <option value='CPV-F'>CPV-F</option>
    <option value='CPV-G'>CPV-G</option>
    <option value='CPV-H'>CPV-H</option>
    <option value='CPV-I'>CPV-I</option>
    <option value='CPV-J'>CPV-J</option>
  </select>

  <div class='row'>
    <div class='row'>
      <div class='four columns'>
        <h5 class='centered'>Area of Interest</h5>
        <svg id='aoi' height='480'></svg>
      </div>
      <div class='four columns'>
        <h5 class='centered'>User Data Filters</h5>
        <svg id='datacoverage' height='480'></svg>
      </div>
      <div class='four columns'>
        <h5 class='centered'>User Actions</h5>
        <svg id='as' height='480'></svg>
      </div>
    </div>
    <div class='row'>
      <div class='twelve columns' id='timeControl'></div>
      <button onclick='removeBrush()'>Clear Brush</button>
    </div>
  </div>

  <!-- <div id='heatmap'></div> -->

  <script>

  // function insertHeatmap () {
  //   var link = document.querySelector('link[rel="import"]')
  //   var content = link.import
  //
  //   var el = content.querySelector('.heatmap')
  //
  //   document.getElementById('heatmap').appendChild(el.cloneNode(true))
  // }

  // insertHeatmap()


  var classKeys = ['overviewHist', 'detailHist', 'graph', 'table', 'offices']

  var bounds = false
  var stackedChart = StackedBarChart(d3.select('#timeControl'))
    .keys(classKeys)
    .onBrushDrag(function (e, extent) {
      bounds = extent
      drawCircularAOI(convertDataForAOI(loadedMouseData, bounds), classKeys)
      drawDataCoverage(convertDataForCoverage(loadedMouseData, bounds))
      drawCircularActionSequence(convertDataForActionSequence(loadedMouseData, bounds))
    })

  var loadedEyeData = []
  var loadedMouseData = []

  function removeBrush () {
    bounds = false
    drawCircularAOI(convertDataForAOI(loadedMouseData, bounds), classKeys)
    drawDataCoverage(convertDataForCoverage(loadedMouseData, bounds))
    drawCircularActionSequence(convertDataForActionSequence(loadedMouseData, bounds))
    stackedChart.clearBrush()
  }

  function onDatasetChange () {
    var value = document.getElementById('dataset').value
    loadData(value)
  }

  document.addEventListener('data-loaded', function () {
    bounds = false
    stackedChart
      .data(timeBinData(loadedMouseData, 90))
      .update()
    drawCircularAOI(convertDataForAOI(loadedMouseData), classKeys)
    drawDataCoverage(convertDataForCoverage(loadedMouseData))
    drawCircularActionSequence(convertDataForActionSequence(loadedMouseData))
  })

  function loadData (value) {
    d3.text('data/converted-' + value + '.csv', function(text) {
      loadedEyeData = d3.csvParse('status,x,y,time,aoi\n' + text)
      d3.json('data/' + value + '.json', function (mouse) {
        loadedMouseData = flattenData(mouse)
        // zipMouseEye(loadedMouseData, loadedEyeData)
        var event = new Event('data-loaded')
        document.dispatchEvent(event)
      })
    })
  }

  loadData('CPV-A')
  </script>
</body>
